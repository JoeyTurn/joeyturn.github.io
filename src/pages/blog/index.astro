---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";
type BlogEntry = CollectionEntry<"blog">;

const posts = await getCollection("blog", ({ data }) => !data.draft && !data.onlylink);

const sortByDateDesc = (a: BlogEntry, b: BlogEntry) =>
  (b.data.pubDate?.getTime?.() ?? 0) - (a.data.pubDate?.getTime?.() ?? 0);

const researchPosts = posts
  .filter((p) => (p.data.tagline ?? "research") === "research")
  .sort(sortByDateDesc);

const notePosts = posts
  .filter((p) => p.data.tagline === "notes")
  .sort(sortByDateDesc);

const fmtDate = (d?: Date) =>
  d ? d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" }) : "";

function groupBySeries(items: BlogEntry[], fallbackLabel: string) {
  const m = new Map<string, BlogEntry[]>();
  for (const p of items) {
    const raw = (p.data as any).series;
    const key =
      typeof raw === "string" && raw.trim().length > 0 ? raw.trim() : fallbackLabel;
    if (!m.has(key)) m.set(key, []);
    m.get(key)!.push(p);
  }
  const keys = Array.from(m.keys()).sort((a, b) => {
    if (a === fallbackLabel) return 1;
    if (b === fallbackLabel) return -1;
    return a.localeCompare(b);
  });
  return keys.map((k) => ({ series: k, posts: m.get(k)! }));
}

const researchGroups = groupBySeries(researchPosts, "Misc");
const noteGroups = groupBySeries(notePosts, "Misc");
---

<BaseLayout title="Joey Turnbull - Blog">
  <div class="blog-index">
    <header class="blog-hero">
      <h1 class="blog-title">Blog</h1>
      <p class="blog-subtitle">Research-y writeups and notes from the trenches.</p>
    </header>

    <main class="blog-main">
      <section class="toc-card">
        <div class="rail" aria-hidden="true"></div>

        <div class="toc-content">

          <h3 class="section-title">Research</h3>

          <p class="toc-blurb">
            Thinking about neural network scaling, training, and feature learning phenomena.
          </p>

          {researchGroups.map((g) => (
            <details class="series" open>
              <summary class="series-summary">
                <span class="chev" aria-hidden="true">▾</span>
                <span class="series-title">{g.series}</span>
                <span class="series-meta">{g.posts.length}</span>
              </summary>

              <ul class="toc-list">
                {g.posts.map(({ slug, data }) => (
                  <li class="toc-item">
                    <a class="row" href={`/blog/${slug}/`}>
                      <span class="tri" aria-hidden="true">▸</span>
                      <span class="post-title">{data.title}</span>
                      {data.pubDate && <span class="post-date">{fmtDate(data.pubDate)}</span>}
                    </a>
                    {data.description && <p class="post-desc">{data.description}</p>}
                  </li>
                ))}
              </ul>
            </details>
          ))}

          <hr class="section-hr" />

          <h3 class="section-title">Notes</h3>
          <p class="toc-blurb">
            Non-technical ideas & findings I think are worth recording/sharing.
          </p>

          {noteGroups.map((g) => (
            <details class="series">
              <summary class="series-summary">
                <span class="chev" aria-hidden="true">▾</span>
                <span class="series-title">{g.series}</span>
                <span class="series-meta">{g.posts.length}</span>
              </summary>

              <ul class="toc-list">
                {g.posts.map(({ slug, data }) => (
                  <li class="toc-item">
                    <a class="row" href={`/blog/${slug}/`}>
                      <span class="tri" aria-hidden="true">▸</span>
                      <span class="post-title">{data.title}</span>
                      {data.pubDate && <span class="post-date">{fmtDate(data.pubDate)}</span>}
                    </a>
                    {data.description && <p class="post-desc">{data.description}</p>}
                  </li>
                ))}
              </ul>
            </details>
          ))}
        </div>
      </section>
    </main>
  </div>

  <style>
    /* === Force the site background (works even if BaseLayout sets body) === */
    :global(html), :global(body) {
      background: #efe6d6;
    }

    .blog-index {
      max-width: 900px;
      margin: 0 auto;
      padding: 2.25rem 1.25rem 3rem;
    }

    .blog-hero { margin-bottom: 1.5rem; }

    .blog-title {
      font-size: clamp(2rem, 2.6vw, 2.6rem);
      line-height: 1.05;
      margin: 0 0 0.5rem;
      letter-spacing: -0.02em;
    }

    .blog-subtitle {
      margin: 0;
      opacity: 0.8;
      max-width: 60ch;
    }

    .toc-card {
      position: relative;
      display: grid;
      grid-template-columns: 14px 1fr;
      gap: 1.25rem;
      padding: 1.5rem 1.25rem;
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 14px;

      /* Key change: no white panel. Let your tan show through. */
      background: transparent;
    }

    /* Optional: add a subtle “paper” panel that still reads as tan */
    .toc-card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 14px;
      background: rgba(255,255,255,0.18);
      pointer-events: none;
    }

    .rail {
      width: 10px;
      border-radius: 999px;
      background: linear-gradient(
        to bottom,
        rgba(234, 88, 12, 0.55),
        rgba(239, 68, 68, 0.45),
        rgba(168, 85, 247, 0.45),
        rgba(59, 130, 246, 0.45)
      );
      box-shadow: 0 0 0 1px rgba(0,0,0,0.06) inset;
      z-index: 1;
    }

    .toc-content { min-width: 0; z-index: 1; }

    .toc-heading {
      font-size: 1.35rem;
      margin: 0 0 0.5rem;
    }

    .toc-blurb {
      margin: 0 0 1rem;
      max-width: 75ch;
      opacity: 0.85;
    }
    .toc-blurb.small {
      margin-top: 0.4rem;
      margin-bottom: 1rem;
      opacity: 0.8;
    }

    .section-title {
      font-size: 1.15rem;
      margin: 1.25rem 0 0.75rem;
      font-weight: 750;
    }

    .section-hr {
      border: none;
      height: 1px;
      background: rgba(0,0,0,0.12);
      margin: 1.25rem 0;
    }

    /* === Series dropdowns === */
    details.series {
      margin: 0 0 1.1rem;
      border-radius: 12px;
    }

    summary.series-summary {
      display: grid;
      grid-template-columns: 1.2rem 1fr auto;
      align-items: baseline;
      gap: 0.5rem;
      cursor: pointer;
      user-select: none;
      padding: 0.35rem 0.25rem 0.5rem;
      list-style: none;
    }
    summary.series-summary::-webkit-details-marker { display: none; }

    .chev {
      display: inline-block;
      transform: translateY(-1px);
      opacity: 0.75;
      transition: transform 140ms ease;
    }
    details.series[open] .chev {
      transform: rotate(180deg) translateY(1px);
      opacity: 0.85;
    }

    /* smaller than Research/Notes */
    .series-title {
      font-size: 0.95rem;
      opacity: 0.75;
      font-weight: 750;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .series-meta {
      opacity: 0.6;
      font-size: 0.9rem;
    }

    /* Post list */
    .toc-list {
      margin: 0;
      padding: 0;
      list-style: none;
      border-top: 1px solid rgba(0,0,0,0.10);
    }

    .toc-item {
      border-bottom: 1px solid rgba(0,0,0,0.10);
      padding: 0.15rem 0;
    }

    .row {
      display: grid;
      grid-template-columns: 1.25rem 1fr auto;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 0.25rem 0.35rem;
      text-decoration: none;
      color: inherit;
    }
    .row:hover .post-title {
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    .tri {
      display: inline-block;
      transform: translateY(-1px);
      opacity: 0.8;
    }

    .post-title {
      font-size: 1.12rem;
      line-height: 1.2;
      min-width: 0;
    }

    .post-date {
      opacity: 0.65;
      font-size: 0.95rem;
      padding-left: 0.75rem;
      white-space: nowrap;
    }

    .post-desc {
      margin: 0 0 0.65rem 1.75rem;
      max-width: 75ch;
      opacity: 0.82;
    }

    @media (max-width: 520px) {
      .toc-card {
        grid-template-columns: 10px 1fr;
        padding: 1.15rem 0.95rem;
        gap: 0.9rem;
      }
      .row {
        grid-template-columns: 1.25rem 1fr;
        padding-bottom: 0.25rem;
      }
      .post-date { display: none; }
      .post-desc { margin-left: 1.5rem; }
    }
  </style>
</BaseLayout>
